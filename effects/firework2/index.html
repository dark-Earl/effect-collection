<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>烟花动画</title>
    <link rel="stylesheet" href="../../static/css/main.css"/>
    <script type="text/javascript" src="../../js/jquery-3.2.1.min.js"></script>
    <style type="text/css">

    </style>
    <script type="text/javascript" src="../../static/js/onlyWeixin.js"></script>
</head>
<body>
<!--返回上一步-->
<!-- <div>
    <div class="ui-header">
        <a href="javascript:history.back();" class="ui-back">
            <div class="ui-trigger"></div>
        </a>
        <div class="ui-title">烟花动画</div>
    </div>
</div> -->

<canvas id="jj-fire-canvas"></canvas>


    <script type="text/javascript">
    let canvas = document.getElementById("jj-fire-canvas");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    canvas.style.cssText = `background: #0001;
         left: 0;
         top: 0;
         position: fixed;
         z-index: -1;`
    // 抓取页面元素，确定烟花可用区域
    let bodyW = 0;//document.getElementById('juejin').getElementsByTagName('div')[0].offsetWidth;
    let browerW = window.innerWidth;

    // 烟花发射位置
    function ramdonX(browerW, bodyW) {
        let diff = parseInt((browerW - bodyW) / 2);
        let x = Math.floor(Math.random() * diff);
        return Math.random() > 0.5 ? x : (browerW - x);
    }
    // 烟花颜色
    let rgb = function () {
        let str = ['1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f'];
        return {
            ramdon() {
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += str[parseInt(Math.floor(Math.random() * 16))]
                }
                return color;
            }
        }
    }();
    let cx = document.getElementById('jj-fire-canvas').getContext('2d');
    cx.strokeStyle = '#fff';
    cx.fillStyle = '#fff';
    cx.lineWidth = 10;
    let hz = 1000 / 75;
    let max = 8;
    // 等待一下dom 加载
    setTimeout(init, 500);

    function init() {
        setTimeout(() => {
            init();
    }, Math.random() * 2500 + 500);
        fireUp(4);
    }
    // fireUp(3)
    let cleanT = setInterval(() => clean(), hz * 1.2);

    function fireUp(r) {
        if (max <= 0) return;
        let ys = Math.random() * 6 + 2;
        let color = rgb.ramdon();
        max--;
        let x = ramdonX(browerW, bodyW)
        let y = window.innerHeight;
        let ramdomTop = parseInt(Math.random() * 500) + 100;
        let time = setInterval(() => {
            if (y < ramdomTop) {
            clearInterval(time);
            drawFiresInRound(x, y);
            fireUp(r);
        }
        y -= ys;
        drawPoint(new Point(x, y, r, color))
    }, hz);

        function drawFiresInRound(x, y) {
            // 根据三角函数计算 x，y

            let arrs = caculatePoints(x, y);
            let time = setInterval(() => {
                if (arrs.length <= 0) {
                clearInterval(time);
                max++;
                return;
            }
            let p = arrs.shift();
            p.forEach(n => drawPoint(n))
        }, hz);
        }
    }
    // 计算四周的点位数据
    function caculatePoints(px, py) {
        let maxR = parseInt(Math.random() * 40) + 20; // 扩散的半径
        /**
         * [p1-x]
         * [p2-x]
         */
        let step = Math.floor(Math.random() * 5) + 10;
        let arrs = [];
        for (let i = step; i <= 360; i += step) {
            arrs.push(new Point(Math.cos(Math.PI / 180 * i).toFixed(4),
                Math.sin(Math.PI / 180 * i).toFixed(4),
                2,
                rgb.ramdon()));
        }
        let randomR = arrs.map(n => Number(Math.random() * 0.4 + 0.8).toFixed(2)).map(n => n ** 3)
        let arrs2 = [];
        for (let i = 1; i < maxR; i++) {
            let j = 0;
            arrs2.push(arrs.map(n => new Point(n.x * i * 1.8 + px,
                n.y * i * 1.5 + py + parseInt(randomR[j++]) * (i ** 1.05),
                n.r, n.color)));
        }
        return arrs2;
    }

    function Point(x, y, r = 2, color = '#fff') {
        return {
            x: x,
            y: y,
            r: r,
            color: color
        }
    }

    function clean() {
        let max = 5000;
        let defaultFillStyle = cx.fillStyle;
        cx.fillStyle = '#0002'
        cx.beginPath();
        cx.fillRect(-max, -max, 2 * max, 2 * max);
        cx.fillStyle = defaultFillStyle;
    }

    function drawPoint(p) {
        let oldColor = cx.fillStyle;
        cx.fillStyle = p.color;
        cx.beginPath();
        cx.arc(p.x, p.y, p.r, 0, 2 * Math.PI);
        cx.fill();
        cx.fillStyle = oldColor;
    }




    </script>
</body>
</html>
